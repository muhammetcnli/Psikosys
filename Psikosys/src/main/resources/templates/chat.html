<!DOCTYPE html>
<html th:lang="${currentLang != null ? currentLang : 'tr'}" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Psikosys</title>
    <link rel="shortcut icon" th:href="@{/images/favicon.ico}" type="image/x-icon">
    <link rel="icon" type="image/x-icon" th:href="@{/images/favicon.ico}" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
    <h2>Psikosys</h2>

    <!-- Dil seÃ§ici eklendi -->
    <div class="language-selector">
        <select id="languageSelect" onchange="changeLanguage()">
            <option value="tr" th:selected="${currentLang == 'tr'}">ðŸ‡¹ðŸ‡· TÃ¼rkÃ§e</option>
            <option value="en" th:selected="${currentLang == 'en'}">ðŸ‡¬ðŸ‡§ English</option>
        </select>
    </div>

    <div class="new-chat-button">
        <a href="/chat">
            <button type="button" th:text="${currentLang == 'en'} ? 'New Chat' : 'Yeni Sohbet'">Yeni Sohbet</button>
        </a>
    </div>

    <div th:if="${userChats != null && !userChats.isEmpty()}">
        <div class="sidebar-section" th:text="${currentLang == 'en'} ? 'Chats' : 'Sohbetler'">Sohbetler</div>

        <a th:each="userChat : ${userChats}"
           th:href="@{'/chat/' + ${userChat.id}}"
           th:class="${chatId != null && chatId == userChat.id} ? 'sidebar-item active' : 'sidebar-item'">
            <div class="sidebar-item-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </div>
            <span th:text="${userChats.size() > 0 && userChat.title != null} ? ${userChat.title} : (${currentLang == 'en'} ? 'Chat ' : 'Sohbet ') + ${userChat.createdAt}">Sohbet BaÅŸlÄ±ÄŸÄ±</span>
        </a>
    </div>

    <!-- Profil butonu -->
    <div class="profile-section">
        <a href="/profile" class="profile-link">
            <div class="profile-button">
                <div class="profile-icon">
                    <img th:if="${userPhoto != null}"
                         th:src="${userPhoto}"
                         alt="Profil"
                         class="profile-photo"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <i class="fas fa-user"
                       th:style="${(user != null and #strings.length(userPhoto) > 0) ? 'display:none;' : 'display:flex;'}">
                    </i>
                </div>
                <span th:text="${userName != null and #strings.length(userName) > 0} ? ${userName} : (${currentLang == 'en'} ? 'Profile' : 'Profil')">Profil</span>
            </div>
        </a>
    </div>
</div>

<!-- Main content area -->
<div class="chat-container">
    <div class="chat-header">
        <h2 th:text="${chat != null && chat.title != null} ? ${chat.title} : 'Psikosys'">Psikosys</h2>
    </div>

    <div class="chat-history">
        <div th:if="${messages != null}">
            <div th:each="message : ${messages}"
                 th:class="${message.isUser} ? 'message user-message' : 'message ai-message'"
                 th:utext="${message.content}">
            </div>
        </div>
    </div>

    <!-- Yeni chat formu -->
    <form th:if="${chatId == null}" class="chat-form" th:action="@{/chat}" method="post">
        <div class="chat-input-wrapper">
            <div class="chat-input-group">
                <textarea name="question" class="chat-input"
                          th:placeholder="${currentLang == 'en'} ? 'Ask anything...' : 'Herhangi bir ÅŸey sor...'" required></textarea>
                <button type="submit"><i class="fas fa-paper-plane"></i></button>
            </div>

            <!-- KiÅŸilik seÃ§ici -->
            <div class="personality-selector">
                <select name="personality" class="personality-select" required>
                    <option value="" th:text="${currentLang == 'en'} ? 'Select Personality...' : 'KiÅŸilik SeÃ§in...'">KiÅŸilik SeÃ§in...</option>
                    <option th:each="personality : ${personalities}"
                            th:value="${personality.key}"
                            th:text="${personality.value.name}">
                    </option>
                </select>
            </div>
        </div>
    </form>

    <!-- Mevcut chat formu -->
    <form th:if="${chatId != null}" class="chat-form" th:action="@{'/chat/' + ${chatId}}" method="post">
        <div class="chat-input-wrapper">
            <div class="chat-input-group">
                <textarea name="question" class="chat-input"
                          th:placeholder="${currentLang == 'en'} ? 'Ask anything...' : 'Herhangi bir ÅŸey sor...'" required></textarea>
                <button type="submit"><i class="fas fa-paper-plane"></i></button>
            </div>

            <!-- KiÅŸilik seÃ§ici -->
            <div class="personality-selector">
                <select name="personality" class="personality-select">
                    <option value="" th:text="${currentLang == 'en'} ? 'Use Current Personality' : 'Mevcut KiÅŸiliÄŸi Kullan'">Mevcut KiÅŸiliÄŸi Kullan</option>
                    <option th:each="personality : ${personalities}"
                            th:value="${personality.key}"
                            th:text="${personality.value.name}"
                            th:selected="${selectedPersonality != null && selectedPersonality == personality.key}">
                    </option>
                </select>
            </div>
        </div>
    </form>
</div>

<script th:src="@{/js/chat.js}"></script>
</body>
</html>